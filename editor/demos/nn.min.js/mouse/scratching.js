// create looping audio player
const filePath = 'https://algorithmicmusic.online/audios/more-spell-on-you.wav'
const player = new Tone.Player(filePath).toDestination()
player.loop = true

// buttons to start/stop player
nn.create('button')
  .content('start')
  .addTo('body')
  .on('click', () => player.start())

nn.create('button')
  .content('stop')
  .addTo('body')
  .on('click', () => player.stop())

// vinyl record image UI
const vinyl = nn.create('img')
  .set('src', '/images/record.png')
  .css('width', 500)
  .addTo('body')

// In this example we turn our mouse track pad into a DJ turntable
// which we can "scratch" like you would a record
let scratching = null // are we currently scratching
let lastX = nn.mouseX // current x position
let lastT = Tone.now() // current time value (in seconds)
let vx = 0 // scratch velocity
let spinAngle = 0 // spin the record

async function scratch () {
  if (scratching) clearTimeout(scratching)

  // first we calculate the velocity of our mouse
  // how fast (and in what direction) have we "scratched"
  const t = Tone.now() // curent time
  let dt = t - lastT // change in time
  if (dt < 0.004) dt = 0.004 // min value
  const dx = nn.mouseX - lastX // change in direction
  vx = dx / dt // velocity (change in motion over time)

  // map velocity down to a better range for a playback rate
  let rate = nn.map(vx, -800, 800, -2, 2)

  // sampleRate requires a positive value
  // so if velocity was negative, lets reverse the player
  player.reverse = rate < 0
  rate = Math.abs(rate) // and ensure it's positive

  // Web Audio doesn't like 0 (zero throws errors)
  const min = 0.001 // but very close to 0 is ok
  if (rate && rate > min) player.playbackRate = rate
  else player.playbackRate = min

  // update for next "scratch" movement
  lastX = nn.mouseX
  lastT = t

  scratching = setTimeout(() => {
    // wait 100ms, after scratching to reset
    player.reverse = false
    player.playbackRate = 1
    vx = 0
  }, 100)
}

// animation loop to spin the vinyl
function animate () {
  requestAnimationFrame(animate) // recursively call animate ~60fps
  if (player.state === 'stopped') return // exit if not playing

  spinAngle += 0.7 // spin speed

  if (vx !== 0) { // if we're scratching
    // map velocity down to a better range for a playback rate
    let sa = nn.map(vx, -800, 800, 2, -2)
    spinAngle += sa
  }

  vinyl.rotate(spinAngle)
}

vinyl.on('mousemove', scratch)
nn.on('load', animate)
